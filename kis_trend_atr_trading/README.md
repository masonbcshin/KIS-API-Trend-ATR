# KIS Trend-ATR Trading System

한국투자증권(KIS) Open API를 활용한 **Trend + ATR 기반 자동매매 시스템**입니다.

> ⚠️ **주의: 이 시스템은 모의투자 전용입니다. 실계좌 사용을 절대 금지합니다.**

---

## 📋 목차

- [개요](#개요)
- [전략 설명](#전략-설명)
- [프로젝트 구조](#프로젝트-구조)
- [설치 방법](#설치-방법)
- [설정](#설정)
- [실행 방법](#실행-방법)
- [주의사항](#주의사항)

---

## 개요

이 시스템은 **추세 추종(Trend Following)** 전략과 **ATR(Average True Range)** 기반의 변동성 손절/익절을 결합한 주식 자동매매 시스템입니다.

### 주요 특징

- 🎯 **Trend + ATR 전략**: 추세와 변동성을 함께 고려
- 📊 **백테스트 기능**: 과거 데이터로 전략 검증
- 🔒 **모의투자 전용**: 실계좌 사용 차단
- 🛡️ **리스크 관리**: ATR 기반 동적 손절/익절, 일일 손실 한도, 킬 스위치
- 📱 **텔레그램 알림**: 실시간 거래/리스크 알림
- 📈 **단일 종목 집중**: 확장 가능한 구조

---

## 전략 설명

### Trend-ATR 전략 개요

```
┌─────────────────────────────────────────────────────────────┐
│                    Trend-ATR 전략                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [추세 판단]                                                │
│    • 종가 > 50일 이동평균 → 상승 추세 ✅                    │
│    • 종가 < 50일 이동평균 → 하락 추세 ❌                    │
│                                                             │
│  [진입 조건]                                                │
│    • 상승 추세 확인                                         │
│    • 직전 캔들 고가 돌파                                    │
│    • 포지션 미보유 상태                                     │
│                                                             │
│  [손절/익절]                                                │
│    • 손절가 = 진입가 - (ATR × 2.0)                         │
│    • 익절가 = 진입가 + (ATR × 3.0)                         │
│                                                             │
│  [포지션 관리]                                              │
│    • 포지션 보유 중 추가 진입 금지                          │
│    • 손절 또는 익절 도달 시 청산                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### ATR(Average True Range)이란?

ATR은 변동성을 측정하는 기술적 지표입니다:

```
True Range = MAX(
    고가 - 저가,
    |고가 - 전일 종가|,
    |저가 - 전일 종가|
)

ATR = True Range의 14일 이동평균
```

### 왜 ATR을 사용하는가?

1. **변동성에 따른 동적 손절/익절**: 변동성이 큰 종목은 넓은 손절폭, 작은 종목은 좁은 손절폭
2. **시장 적응력**: 변동성 변화에 자동으로 대응
3. **리스크 표준화**: 다양한 종목에 일관된 리스크 관리 가능

---

## 프로젝트 구조

```
kis_trend_atr_trading/
├── config/
│   ├── __init__.py
│   └── settings.py          # 시스템 설정 (API URL, 전략 파라미터)
├── api/
│   ├── __init__.py
│   └── kis_api.py           # KIS Open API 클라이언트
├── strategy/
│   ├── __init__.py
│   └── trend_atr.py         # Trend-ATR 전략 구현
├── engine/
│   ├── __init__.py
│   ├── executor.py          # 거래 실행 엔진
│   └── risk_manager.py      # 리스크 관리 모듈
├── backtest/
│   ├── __init__.py
│   └── backtester.py        # 백테스트 모듈
├── utils/
│   ├── __init__.py
│   ├── logger.py            # 로깅 유틸리티
│   └── telegram_notifier.py # 텔레그램 알림 모듈
├── logs/                    # 로그 파일 저장 디렉토리
├── main.py                  # 메인 실행 파일
├── requirements.txt         # 의존성 패키지 목록
├── .env.example             # 환경변수 예시 파일
└── README.md                # 이 파일
```

---

## 설치 방법

### 1. 저장소 클론

```bash
git clone <repository-url>
cd kis_trend_atr_trading
```

### 2. 가상환경 생성 (권장)

```bash
python -m venv venv

# Windows
venv\Scripts\activate

# macOS/Linux
source venv/bin/activate
```

### 3. 의존성 설치

```bash
pip install -r requirements.txt
```

### 4. 환경변수 설정

```bash
# .env.example을 .env로 복사
cp .env.example .env

# .env 파일 수정
nano .env  # 또는 선호하는 편집기 사용
```

---

## 설정

### 환경변수 (.env)

```env
# 한국투자증권 모의투자 API 키
KIS_APP_KEY=your_app_key_here
KIS_APP_SECRET=your_app_secret_here

# 모의투자 계좌 정보
KIS_ACCOUNT_NO=12345678
KIS_ACCOUNT_PRODUCT_CODE=01
```

### API 키 발급 방법

1. [한국투자증권 Open API 포털](https://apiportal.koreainvestment.com/) 접속
2. 회원가입 및 로그인
3. **모의투자** 앱 키 발급 (실전투자 키 사용 금지!)
4. 발급받은 키를 `.env` 파일에 입력

### 전략 파라미터 (config/settings.py)

```python
# ATR(Average True Range) 계산 기간
ATR_PERIOD = 14

# 추세 판단용 이동평균 기간
TREND_MA_PERIOD = 50

# 손절 배수 (ATR 기준)
ATR_MULTIPLIER_SL = 2.0

# 익절 배수 (ATR 기준)
ATR_MULTIPLIER_TP = 3.0
```

---

## 📱 텔레그램 알림 설정

자동매매 시스템의 이벤트를 실시간으로 텔레그램 메시지로 받을 수 있습니다.

### 지원 알림 유형

| 이벤트 | 설명 |
|--------|------|
| 📈 매수 주문 | 신규 포지션 진입 시 |
| 📉 매도 주문 | 포지션 청산 시 |
| 🛑 손절 청산 | 손절가 도달로 청산 시 |
| 🎯 익절 청산 | 익절가 도달로 청산 시 |
| ⚠️ 일일 손실 한도 | 일일 손실 한도 도달 시 |
| 🚨 킬 스위치 | 긴급 정지 발동 시 |
| 🚀 시스템 시작 | 자동매매 시작 시 |
| ⏹️ 시스템 종료 | 자동매매 종료 시 |
| ❌ 오류 발생 | 시스템 오류 발생 시 |

### 1. 텔레그램 봇 생성

```
1. 텔레그램에서 @BotFather 검색하여 대화 시작
2. /newbot 명령어 입력
3. 봇 이름 입력 (예: KIS Trading Alert)
4. 봇 사용자명 입력 (예: kis_trading_alert_bot)
   - 반드시 _bot으로 끝나야 합니다
5. 발급된 토큰 복사 (예: 1234567890:ABCdefGHIjklMNOpqrsTUVwxyz)
```

⚠️ **주의: 토큰은 절대 공개하지 마세요!**

### 2. Chat ID 확인

**방법 1: 1:1 채팅**
```
1. 생성한 봇 검색하여 대화 시작
2. /start 메시지 전송
3. 브라우저에서 아래 URL 접속:
   https://api.telegram.org/bot<토큰>/getUpdates
4. 응답에서 "chat":{"id":XXXXXXXX} 부분의 숫자가 Chat ID
```

**방법 2: 그룹 채팅**
```
1. 봇을 그룹에 추가
2. 그룹에서 아무 메시지 전송
3. 위와 동일하게 getUpdates로 chat_id 확인
   (그룹 ID는 음수입니다. 예: -1001234567890)
```

### 3. 환경변수 설정

`.env` 파일에 아래 내용 추가:

```env
# 텔레그램 봇 토큰
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz

# 텔레그램 채팅 ID (개인 또는 그룹)
TELEGRAM_CHAT_ID=123456789

# 텔레그램 알림 활성화 (true/false)
TELEGRAM_ENABLED=true
```

### 4. 연결 테스트

```python
from utils.telegram_notifier import get_telegram_notifier

notifier = get_telegram_notifier()
notifier.test_connection()  # 테스트 메시지가 전송됩니다
```

### 5. 텔레그램 메시지 예시

**매수 주문 체결**
```
📈 매수 주문 체결
━━━━━━━━━━━━━━━━━━
• 종목: 005930
• 체결가: 70,000원
• 수량: 10주
• 손절가: 67,000원
• 익절가: 79,000원
━━━━━━━━━━━━━━━━━━
⏰ 2024-01-15 14:30:25
```

**손절 청산**
```
🛑 손절 청산 완료
━━━━━━━━━━━━━━━━━━
• 종목: 005930
• 진입가: 70,000원
• 청산가: 67,000원
• 손실: -30,000원 (-4.29%)
━━━━━━━━━━━━━━━━━━
💡 손절 기준에 따라 포지션이 청산되었습니다.
⏰ 2024-01-16 10:15:42
```

**일일 손실 한도 도달**
```
⚠️ 일일 손실 한도 도달
━━━━━━━━━━━━━━━━━━
• 당일 누적 손실: 300,000원
• 손실률: 3.00%
• 한도: -3.0%
━━━━━━━━━━━━━━━━━━
🔒 신규 주문이 차단되었습니다.
   기존 포지션 청산만 허용됩니다.
⏰ 2024-01-17 11:20:33
```

---

## 실행 방법

### 백테스트 실행

과거 데이터를 기반으로 전략 성과를 검증합니다.

```bash
# 기본 실행 (삼성전자, 365일)
python main.py --mode backtest

# 종목 지정
python main.py --mode backtest --stock 005930

# 기간 지정
python main.py --mode backtest --stock 005930 --days 500
```

### 모의투자 실행

실시간 시세를 기반으로 모의투자 주문을 실행합니다.

```bash
# 기본 실행 (60초 간격)
python main.py --mode trade

# 종목 및 간격 지정
python main.py --mode trade --stock 005930 --interval 120

# 최대 실행 횟수 지정
python main.py --mode trade --max-runs 100
```

### 명령행 옵션

| 옵션 | 설명 | 기본값 |
|------|------|--------|
| `--mode` | 실행 모드 (backtest/trade) | 필수 |
| `--stock` | 종목 코드 | 005930 |
| `--interval` | 실행 간격 (초) | 60 |
| `--max-runs` | 최대 실행 횟수 | 무제한 |
| `--days` | 백테스트 기간 (일) | 365 |

---

## 백테스트 결과 해석

```
═══════════════════════════════════════════════════════════════════
                    백테스트 결과 요약
═══════════════════════════════════════════════════════════════════
📅 기간: 2024-01-01 ~ 2024-12-31

💰 자본금 변화
   - 초기 자본금:      10,000,000 원
   - 최종 자본금:      11,234,567 원
   - 총 수익률:             12.35 %

📊 거래 통계
   - 총 거래 횟수:          15 회
   - 승리:                   9 회
   - 패배:                   6 회
   - 승률:               60.00 %

📉 리스크 지표
   - 최대 낙폭(MDD):       8.45 %
   - 수익 팩터:            1.85

⏱️ 보유 기간
   - 평균 보유 기간:       12.3 일
═══════════════════════════════════════════════════════════════════
```

### 지표 설명

- **총 수익률**: (최종 자본금 - 초기 자본금) / 초기 자본금 × 100
- **승률**: 수익 거래 / 전체 거래 × 100
- **최대 낙폭(MDD)**: 고점 대비 최대 하락률
- **수익 팩터**: 총 수익 / 총 손실 (1 이상이면 수익)

---

## 주의사항

### ⚠️ 필수 주의사항

1. **실계좌 사용 절대 금지**
   - 이 시스템은 모의투자 전용입니다
   - 실계좌 API 키를 사용하지 마세요

2. **투자 손실 주의**
   - 백테스트 결과가 미래 수익을 보장하지 않습니다
   - 모든 투자에는 손실 위험이 있습니다

3. **API Rate Limit**
   - KIS API는 초당 20회 호출 제한이 있습니다
   - 시스템이 자동으로 관리하지만, 과도한 요청을 피하세요

4. **초단타 금지**
   - 1분 미만 간격의 거래는 지원하지 않습니다
   - 최소 실행 간격은 60초입니다

### 🔒 보안 주의사항

1. `.env` 파일을 Git에 커밋하지 마세요
2. API 키를 공개 저장소에 노출하지 마세요
3. 정기적으로 API 키를 갱신하세요

---

## 라이선스

이 프로젝트는 교육 및 연구 목적으로 제공됩니다.
실제 투자에 사용하여 발생하는 손실에 대해 개발자는 책임지지 않습니다.

---

## 문의

문제가 발생하거나 개선 사항이 있으면 Issue를 등록해 주세요.
