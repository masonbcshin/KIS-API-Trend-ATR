# KIS Trend-ATR Trading System

한국투자증권(KIS) Open API를 활용한 **Trend + ATR 기반 자동매매 시스템**입니다.

> ⚠️ **주의: 이 시스템은 모의투자 전용입니다. 실계좌 사용을 절대 금지합니다.**

---

## 📋 목차

- [개요](#개요)
- [전략 설명](#전략-설명)
- [프로젝트 구조](#프로젝트-구조)
- [설치 방법](#설치-방법)
- [설정](#설정)
- [실행 방법](#실행-방법)
- [주의사항](#주의사항)

---

## 개요

이 시스템은 **추세 추종(Trend Following)** 전략과 **ATR(Average True Range)** 기반의 변동성 손절/익절을 결합한 주식 자동매매 시스템입니다.

### 주요 특징

- 🎯 **Trend + ATR 전략**: 추세와 변동성을 함께 고려
- 📊 **백테스트 기능**: 과거 데이터로 전략 검증
- 🔒 **모의투자 전용**: 실계좌 사용 차단
- 🛡️ **리스크 관리**: ATR 기반 동적 손절/익절
- 📈 **단일 종목 집중**: 확장 가능한 구조

---

## 전략 설명

### Trend-ATR 전략 개요

```
┌─────────────────────────────────────────────────────────────┐
│                    Trend-ATR 전략                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [추세 판단]                                                │
│    • 종가 > 50일 이동평균 → 상승 추세 ✅                    │
│    • 종가 < 50일 이동평균 → 하락 추세 ❌                    │
│                                                             │
│  [진입 조건]                                                │
│    • 상승 추세 확인                                         │
│    • 직전 캔들 고가 돌파                                    │
│    • 포지션 미보유 상태                                     │
│                                                             │
│  [손절/익절]                                                │
│    • 손절가 = 진입가 - (ATR × 2.0)                         │
│    • 익절가 = 진입가 + (ATR × 3.0)                         │
│                                                             │
│  [포지션 관리]                                              │
│    • 포지션 보유 중 추가 진입 금지                          │
│    • 손절 또는 익절 도달 시 청산                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### ATR(Average True Range)이란?

ATR은 변동성을 측정하는 기술적 지표입니다:

```
True Range = MAX(
    고가 - 저가,
    |고가 - 전일 종가|,
    |저가 - 전일 종가|
)

ATR = True Range의 14일 이동평균
```

### 왜 ATR을 사용하는가?

1. **변동성에 따른 동적 손절/익절**: 변동성이 큰 종목은 넓은 손절폭, 작은 종목은 좁은 손절폭
2. **시장 적응력**: 변동성 변화에 자동으로 대응
3. **리스크 표준화**: 다양한 종목에 일관된 리스크 관리 가능

---

## 프로젝트 구조

```
kis_trend_atr_trading/
├── config/
│   ├── __init__.py
│   └── settings.py          # 시스템 설정 (API URL, 전략 파라미터)
├── api/
│   ├── __init__.py
│   └── kis_api.py           # KIS Open API 클라이언트
├── strategy/
│   ├── __init__.py
│   └── trend_atr.py         # Trend-ATR 전략 구현
├── engine/
│   ├── __init__.py
│   └── executor.py          # 거래 실행 엔진
├── backtest/
│   ├── __init__.py
│   └── backtester.py        # 백테스트 모듈
├── utils/
│   ├── __init__.py
│   └── logger.py            # 로깅 유틸리티
├── logs/                    # 로그 파일 저장 디렉토리
├── main.py                  # 메인 실행 파일
├── requirements.txt         # 의존성 패키지 목록
├── .env.example             # 환경변수 예시 파일
└── README.md                # 이 파일
```

---

## 설치 방법

### 1. 저장소 클론

```bash
git clone <repository-url>
cd kis_trend_atr_trading
```

### 2. 가상환경 생성 (권장)

```bash
python -m venv venv

# Windows
venv\Scripts\activate

# macOS/Linux
source venv/bin/activate
```

### 3. 의존성 설치

```bash
pip install -r requirements.txt
```

### 4. 환경변수 설정

```bash
# .env.example을 .env로 복사
cp .env.example .env

# .env 파일 수정
nano .env  # 또는 선호하는 편집기 사용
```

---

## 설정

### 환경변수 (.env)

```env
# 한국투자증권 모의투자 API 키
KIS_APP_KEY=your_app_key_here
KIS_APP_SECRET=your_app_secret_here

# 모의투자 계좌 정보
KIS_ACCOUNT_NO=12345678
KIS_ACCOUNT_PRODUCT_CODE=01
```

### API 키 발급 방법

1. [한국투자증권 Open API 포털](https://apiportal.koreainvestment.com/) 접속
2. 회원가입 및 로그인
3. **모의투자** 앱 키 발급 (실전투자 키 사용 금지!)
4. 발급받은 키를 `.env` 파일에 입력

### 전략 파라미터 (config/settings.py)

```python
# ATR(Average True Range) 계산 기간
ATR_PERIOD = 14

# 추세 판단용 이동평균 기간
TREND_MA_PERIOD = 50

# 손절 배수 (ATR 기준)
ATR_MULTIPLIER_SL = 2.0

# 익절 배수 (ATR 기준)
ATR_MULTIPLIER_TP = 3.0
```

---

## 실행 방법

### 백테스트 실행

과거 데이터를 기반으로 전략 성과를 검증합니다.

```bash
# 기본 실행 (삼성전자, 365일)
python main.py --mode backtest

# 종목 지정
python main.py --mode backtest --stock 005930

# 기간 지정
python main.py --mode backtest --stock 005930 --days 500
```

### 모의투자 실행

실시간 시세를 기반으로 모의투자 주문을 실행합니다.

```bash
# 기본 실행 (60초 간격)
python main.py --mode trade

# 종목 및 간격 지정
python main.py --mode trade --stock 005930 --interval 120

# 최대 실행 횟수 지정
python main.py --mode trade --max-runs 100
```

### 명령행 옵션

| 옵션 | 설명 | 기본값 |
|------|------|--------|
| `--mode` | 실행 모드 (backtest/trade) | 필수 |
| `--stock` | 종목 코드 | 005930 |
| `--interval` | 실행 간격 (초) | 60 |
| `--max-runs` | 최대 실행 횟수 | 무제한 |
| `--days` | 백테스트 기간 (일) | 365 |

---

## 백테스트 결과 해석

```
═══════════════════════════════════════════════════════════════════
                    백테스트 결과 요약
═══════════════════════════════════════════════════════════════════
📅 기간: 2024-01-01 ~ 2024-12-31

💰 자본금 변화
   - 초기 자본금:      10,000,000 원
   - 최종 자본금:      11,234,567 원
   - 총 수익률:             12.35 %

📊 거래 통계
   - 총 거래 횟수:          15 회
   - 승리:                   9 회
   - 패배:                   6 회
   - 승률:               60.00 %

📉 리스크 지표
   - 최대 낙폭(MDD):       8.45 %
   - 수익 팩터:            1.85

⏱️ 보유 기간
   - 평균 보유 기간:       12.3 일
═══════════════════════════════════════════════════════════════════
```

### 지표 설명

- **총 수익률**: (최종 자본금 - 초기 자본금) / 초기 자본금 × 100
- **승률**: 수익 거래 / 전체 거래 × 100
- **최대 낙폭(MDD)**: 고점 대비 최대 하락률
- **수익 팩터**: 총 수익 / 총 손실 (1 이상이면 수익)

---

## 주의사항

### ⚠️ 필수 주의사항

1. **실계좌 사용 절대 금지**
   - 이 시스템은 모의투자 전용입니다
   - 실계좌 API 키를 사용하지 마세요

2. **투자 손실 주의**
   - 백테스트 결과가 미래 수익을 보장하지 않습니다
   - 모든 투자에는 손실 위험이 있습니다

3. **API Rate Limit**
   - KIS API는 초당 20회 호출 제한이 있습니다
   - 시스템이 자동으로 관리하지만, 과도한 요청을 피하세요

4. **초단타 금지**
   - 1분 미만 간격의 거래는 지원하지 않습니다
   - 최소 실행 간격은 60초입니다

### 🔒 보안 주의사항

1. `.env` 파일을 Git에 커밋하지 마세요
2. API 키를 공개 저장소에 노출하지 마세요
3. 정기적으로 API 키를 갱신하세요

---

## 라이선스

이 프로젝트는 교육 및 연구 목적으로 제공됩니다.
실제 투자에 사용하여 발생하는 손실에 대해 개발자는 책임지지 않습니다.

---

## 문의

문제가 발생하거나 개선 사항이 있으면 Issue를 등록해 주세요.
